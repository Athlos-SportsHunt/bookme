{{ turf.name }} <br>
{{ turf.venue.name }}
<br>
<form id="booking-form" method="post" action="{% url 'api:handle_booking' %}">
    {% csrf_token %}
    <div>
        <label for="date">Date:</label>
        <input type="datetime-local" id="date" name="date" value="{{ today_date }}" required>
    </div>
    <div>
        <label for="duration">Duration (minutes):</label>
        <input type="number" id="duration" name="duration" min="60" step="30" value="60" required>
        <button type="button" id="increase-duration">Increase Duration</button>
    </div>
    <button type="submit">Book Now</button>
</form>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById('increase-duration').addEventListener('click', function() {
    var durationInput = document.getElementById('duration');
    var currentDuration = parseInt(durationInput.value);
    durationInput.value = currentDuration + 30;
});

document.getElementById('booking-form').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    var date = document.getElementById('date').value;
    var duration = document.getElementById('duration').value;
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    var data = {
        venue_id: '{{ turf.venue.id }}', // Assuming you have venue.id available in the context
        turf_id: '{{ turf.id }}', // Assuming you have turf.id available in the context
        start_date: date,
        duration: duration
    };

    fetch("{% url 'api:handle_booking' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.order_details) {
            var options = {
                key: data.RAZORPAY_KEY_ID,
                amount: data.order_details.amount,
                currency: data.order_details.currency,
                name: "{{ turf.venue.name }}",
                description: "Booking for {{ turf.name }}",
                order_id: data.order_details.id,
                callback_url: data.callback_url,
                
                handler: function (response) {
                    alert("Payment Successful!\nPayment ID: " + response.razorpay_payment_id);
                    window.location.href = data.callback_url;
                },
                prefill: {
                    name: "{{ request.user.username }}",
                    email: "{{ request.user.email }}",
                    contact: "{{ request.user.profile.phone_number }}" // Assuming you have phone_number in user profile
                },
                theme: {
                    color: "#3399cc"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response){
                alert("Payment Failed!\nError: " + response.error.description);
            });
            rzp1.open();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Booking failed!');
    });
});
</script>
